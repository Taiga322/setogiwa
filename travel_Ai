import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { 
  getFirestore, doc, setDoc, onSnapshot, collection, query, 
  serverTimestamp 
} from 'firebase/firestore'; // whereã‚’å‰Šé™¤ (ãƒ‘ã‚¹ã§ã‚¹ã‚³ãƒ¼ãƒ—ã™ã‚‹ãŸã‚ä¸è¦)

// --- Firebase Configuration & Setup ---
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€ï¼ˆCanvasç’°å¢ƒå¿…é ˆï¼‰
const firebaseConfig = typeof __firebase_config !== 'undefined' 
  ? JSON.parse(__firebase_config) 
  : { /* é–‹ç™ºç’°å¢ƒå‘ã‘ãƒ€ãƒŸãƒ¼è¨­å®š */ };

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// API Key (Canvasç’°å¢ƒã§è‡ªå‹•æä¾›ã•ã‚Œã‚‹ãŸã‚ã€ç©ºæ–‡å­—åˆ—ã§OK)
const API_KEY = ""; 
// â˜…ä¿®æ­£1: APIã‚­ãƒ¼ã‚’å«ã¾ãªã„ãƒ™ãƒ¼ã‚¹URLã‚’å®šç¾©
const GEMINI_API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";


// Voice Configuration for TTS (TTSæ©Ÿèƒ½ã¯ä»Šå›ã¯å«ã¿ã¾ã›ã‚“)
const SPEAKER_VOICES = {
    'Joe': 'Kore',
    'Jane': 'Puck'
};


// --- Utility Functions ---

/**
 * Exponential backoff for API calls
 */
const fetchWithRetry = async (url, options, retries = 3) => {
  // â˜…ä¿®æ­£2: URLã«API KEYã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€Canvasã§ã®è‡ªå‹•ç½®æ›ã‚’ç¢ºå®Ÿã«ã™ã‚‹
  const apiUrl = `${url}?key=${API_KEY}`; 
    
  if (API_KEY === "") {
    console.log("DEBUG: API_KEY is empty. Relying on Canvas runtime injection.");
  }
    
  for (let i = 0; i < retries; i++) {
    try {
      const response = await fetch(apiUrl, options);
      if (response.ok) {
        return response;
      }
      // Retry on certain HTTP error codes (e.g., 5xx)
      if (response.status >= 500 && response.status < 600 && i < retries - 1) {
        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
        await new Promise(resolve => setTimeout(resolve, delay));
        continue;
      }
      // 401, 403, 404 ãªã©ã®ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤ã›ãšã«ä¾‹å¤–ã‚’æŠ•ã’ã‚‹
      throw new Error(`API Request failed with status ${response.status}`);
    } catch (error) {
      if (i === retries - 1) throw error;
      const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
};


// --- React Components ---

/**
 * æ—…ç¨‹ã®è¡¨ç¤ºã¨ç·¨é›†ã‚’è¡Œã†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 */
const PlanDisplay = ({ plan, isEditable, onUpdatePlan, isMyPlan }) => {
  const [editingPlan, setEditingPlan] = useState(plan);
  
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒãƒ³ãƒ‰ãƒ©
  const handleEditChange = (dayIndex, activityIndex, field, value) => {
    const newPlan = JSON.parse(JSON.stringify(editingPlan));
    if (!newPlan.itinerary_json.days) return;

    newPlan.itinerary_json.days[dayIndex].activities[activityIndex][field] = value;
    setEditingPlan(newPlan);
  };
  
  // å¤‰æ›´ã‚’Firestoreã«ä¿å­˜ã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©
  const handleSave = () => {
    onUpdatePlan(editingPlan);
    // window.alert() ã®ä»£ã‚ã‚Šã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨
    // alert('ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼åŒè¡Œè€…ã«ã‚‚åæ˜ ã•ã‚Œã¾ã™ã€‚'); 
    console.log('ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼åŒè¡Œè€…ã«ã‚‚åæ˜ ã•ã‚Œã¾ã™ã€‚');
  };

  useEffect(() => {
    if (plan) {
      setEditingPlan(plan);
    }
  }, [plan]);

  if (!plan || !plan.itinerary_json || !plan.itinerary_json.days) {
    return <div className="text-center p-8 text-gray-500">ã¾ã ãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚AIã«ä½œæˆã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚</div>;
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-md">
          <h2 className="text-xl font-bold text-gray-800">
              âœˆï¸ {plan.itinerary_json.destination} ã®æ—… ({plan.itinerary_json.days.length}æ—¥é–“)
          </h2>
          {isEditable && (
            <button 
                onClick={handleSave}
                className="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition duration-200"
            >
                ğŸ”„ ãƒ—ãƒ©ãƒ³ã‚’åŒæœŸãƒ»ä¿å­˜
            </button>
          )}
      </div>

      {editingPlan.itinerary_json.days.map((day, dayIndex) => (
        <div key={dayIndex} className="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500">
          <h3 className="text-lg font-bold mb-4 text-indigo-700">
            Day {day.day_number}: {day.date}
          </h3>
          <ul className="space-y-4">
            {day.activities.map((activity, activityIndex) => (
              <li key={activityIndex} className="flex items-start space-x-3 p-3 bg-indigo-50 rounded-lg shadow-sm">
                <span className="flex-shrink-0 mt-1 text-indigo-500 text-lg">
                  {activity.spot_name.includes('å®¿æ³Š') ? 'ğŸ¨' : activity.spot_name.includes('ç§»å‹•') ? 'ğŸš—' : 'ğŸ“'}
                </span>
                <div className="flex-grow">
                  <div className="font-semibold text-gray-800">
                    {isEditable ? (
                        <input
                            type="text"
                            value={activity.spot_name}
                            onChange={(e) => handleEditChange(dayIndex, activityIndex, 'spot_name', e.target.value)}
                            className="w-full font-bold bg-white border border-gray-300 rounded p-1"
                        />
                    ) : (
                        activity.spot_name
                    )}
                  </div>
                  <div className="text-sm text-gray-600 mt-0.5 flex space-x-2">
                    <span className="font-medium text-indigo-500">
                        {isEditable ? (
                            <input
                                type="text"
                                value={activity.time}
                                onChange={(e) => handleEditChange(dayIndex, activityIndex, 'time', e.target.value)}
                                className="w-16 bg-white border border-gray-300 rounded p-1"
                            />
                        ) : (
                            activity.time
                        )}
                    </span>
                    <span>| æ»åœ¨: {activity.duration}åˆ†</span>
                  </div>
                  {activity.notes && <p className="text-xs italic text-gray-500 mt-1">{activity.notes}</p>}
                </div>
              </li>
            ))}
          </ul>
        </div>
      ))}
    </div>
  );
};


/**
 * æ—…ãƒŠã‚«AIãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 */
const AIChat = ({ currentPlan, userId }) => {
  const [messages, setMessages] = useState([
    { role: 'ai', text: 'ã“ã‚“ã«ã¡ã¯ï¼æ—…ã®è¨­è¨ˆå£«AIã§ã™ã€‚æ—…ã®é€”ä¸­ã§ã®æ€¥ãªäºˆå®šå¤‰æ›´ã‚„ã€å›°ã£ãŸã“ã¨ãŒã‚ã‚Œã°ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã­ã€‚' }
  ]);
  const [input, setInput] = useState('');
  const [isTyping, setIsTyping] = useState(false);

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã™ã‚‹AIå¿œç­”ãƒ­ã‚¸ãƒƒã‚¯
  const getAIResponse = async (userText) => {
    setIsTyping(true);
    
    // ç¾åœ¨ã®æ—…ã®çŠ¶æ³ã‚’AIã«ä¼ãˆã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ± (é‡è¦)
    const currentContext = {
      user_id: userId,
      current_time: new Date().toLocaleTimeString('ja-JP'),
      plan_summary: currentPlan ? JSON.stringify(currentPlan.itinerary_json, null, 2) : 'ãƒ—ãƒ©ãƒ³ã¯ã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚',
      user_query: userText,
      // å®Ÿéš›ã«ã¯ GPS æƒ…å ±ã€å¤©æ°—æƒ…å ±ãªã©ã‚’ã“ã“ã«è¿½åŠ ã™ã‚‹
      simulated_context: {
        location: 'æ²–ç¸„çœŒé‚£è¦‡å¸‚ã®å›½éš›é€šã‚Šä»˜è¿‘',
        next_plan: currentPlan && currentPlan.itinerary_json.days.length > 0 && currentPlan.itinerary_json.days[0].activities.length > 1 
          ? currentPlan.itinerary_json.days[0].activities[1].spot_name 
          : 'æœªå®š',
        weather: 'å¿«æ™´'
      }
    };
    
    const systemPrompt = `ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’çŸ¥ã£ã¦ã„ã‚‹å°‚é–€ã®æ—…è¡Œã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥AIã§ã™ã€‚
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®è³ªå•ã«å¯¾ã—ã€ç¾åœ¨ã®æ—…ç¨‹ã¨çŠ¶æ³ï¼ˆ${currentContext.simulated_context.location}ãªã©ï¼‰ã«åŸºã¥ã„ã¦ã€å…·ä½“çš„ã§è¦ªåˆ‡ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã—ã¦ãã ã•ã„ã€‚
    ãƒ—ãƒ©ãƒ³ã«é–¢ã™ã‚‹è³ªå•ã«ã¯ãƒ—ãƒ©ãƒ³ï¼ˆ${currentContext.plan_summary}ï¼‰ã®å†…å®¹ã‚’å‚ç…§ã—ã€ãƒ—ãƒ©ãƒ³ã«ãªã„è³ªå•ã«ã¯ä¸€èˆ¬çš„ãªæ—…è¡Œæƒ…å ±ã‚„ä»£æ›¿æ¡ˆã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
    ä¼šè©±ã¯æ—¥æœ¬èªã§è¡Œã„ã€ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã§è¦ªåˆ‡ãªãƒˆãƒ¼ãƒ³ã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚`;
    
    const userQuery = `ç¾åœ¨ã®çŠ¶æ³: ${JSON.stringify(currentContext.simulated_context)}\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®è³ªå•: ${userText}\n\næ—…ç¨‹: ${currentContext.plan_summary}`;

    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
    };

    try {
        // AIChatå†…ã®APIå‘¼ã³å‡ºã—ã‚‚BASE URLã‚’ä½¿ç”¨
        const response = await fetchWithRetry(GEMINI_API_BASE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text || "ã™ã¿ã¾ã›ã‚“ã€å¿œç­”ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";

        setMessages(prev => [...prev, { role: 'ai', text: aiText }]);
    } catch (error) {
        console.error("Gemini API Error:", error);
        setMessages(prev => [...prev, { role: 'ai', text: 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚ï¼ˆã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: 401ã®å¯èƒ½æ€§ï¼‰' }]);
    } finally {
        setIsTyping(false);
    }
  };

  const handleSend = () => {
    if (!input.trim() || isTyping) return;
    
    const userText = input;
    setMessages(prev => [...prev, { role: 'user', text: userText }]);
    setInput('');
    
    getAIResponse(userText);
  };

  return (
    <div className="flex flex-col h-full bg-white rounded-xl shadow-2xl p-4">
      <h2 className="text-xl font-bold mb-3 text-indigo-700 border-b pb-2">ğŸ¤– æ—…ãƒŠã‚« AIã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥</h2>
      <div className="flex-grow overflow-y-auto space-y-4 p-2 custom-scrollbar">
        {messages.map((msg, index) => (
          <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-[80%] p-3 rounded-2xl shadow-md ${
              msg.role === 'user' 
                ? 'bg-indigo-500 text-white rounded-br-none' 
                : 'bg-gray-100 text-gray-800 rounded-tl-none'
            }`}>
              {msg.text}
            </div>
          </div>
        ))}
        {isTyping && (
             <div className="flex justify-start">
                <div className="max-w-[80%] p-3 rounded-2xl shadow-md bg-gray-100 text-gray-800 rounded-tl-none italic text-sm">
                   AIãŒè€ƒãˆä¸­ã§ã™...
                </div>
            </div>
        )}
      </div>
      <div className="mt-4 flex space-x-2">
        <input
          type="text"
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyDown={(e) => e.key === 'Enter' && handleSend()}
          placeholder="AIã«æ—…ã®ç›¸è«‡ã‚’ã™ã‚‹..."
          className="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 transition duration-150"
          disabled={isTyping}
        />
        <button
          onClick={handleSend}
          className="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-5 rounded-xl shadow-lg transition duration-200 disabled:opacity-50"
          disabled={!input.trim() || isTyping}
        >
          é€ä¿¡
        </button>
      </div>
    </div>
  );
};


/**
 * ãƒ—ãƒ©ãƒ³ç”Ÿæˆãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 */
const PlanGeneratorForm = ({ setPlanData, auth }) => { 
  const [step, setStep] = useState(1);
  const [theme, setTheme] = useState('');
  const [destination, setDestination] = useState('');
  const [destinationCandidates, setDestinationCandidates] = useState([]);
  const [themeText, setThemeText] = useState('');
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState('');
  
  const THEME_OPTIONS = [
      { id: 'relax', label: 'ğŸ–ï¸ ç™’ã‚„ã—ãƒ»ãƒªãƒ©ãƒƒã‚¯ã‚¹', prompt: 'æ¸©æ³‰ã€ãƒ“ãƒ¼ãƒã€è‡ªç„¶æ™¯è¦³ã‚’å·¡ã‚Šã€å¿ƒèº«ã¨ã‚‚ã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã§ãã‚‹æ—…' },
      { id: 'gourmet', label: 'ğŸ£ ã‚°ãƒ«ãƒ¡ãƒ»é£Ÿã¹æ­©ã', prompt: 'åœ°å…ƒã®å¸‚å ´ã€ãƒŸã‚·ãƒ¥ãƒ©ãƒ³ã€éš ã‚ŒãŸååº—ãªã©é£Ÿã‚’å ªèƒ½ã™ã‚‹æ—…' },
      { id: 'active', label: 'ğŸ„ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ»ä½“é¨“', prompt: 'ãƒã‚¤ã‚­ãƒ³ã‚°ã€ãƒãƒªãƒ³ã‚¹ãƒãƒ¼ãƒ„ã€æ–‡åŒ–ä½“é¨“ãªã©ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ä¸­å¿ƒã®æ—…' },
      { id: 'culture', label: 'ğŸ¯ æ­´å²ãƒ»æ–‡åŒ–æ¢è¨ª', prompt: 'ä¸–ç•Œéºç”£ã€ç¾è¡“é¤¨ã€æ­´å²çš„ãªè¡—ä¸¦ã¿ã‚’æ·±ãå­¦ã¶æ—…' },
  ];

  // Step 2: ãƒ†ãƒ¼ãƒã«åŸºã¥ã„ãŸæ—…å…ˆå€™è£œã‚’AIã«ç”Ÿæˆã•ã›ã‚‹
  const fetchDestinationCandidates = async () => {
    if (!theme) return;
    setLoading(true);
    setErrorMsg('');
    setDestinationCandidates([]);
    setDestination(''); // å€™è£œãŒå¤‰ã‚ã‚‹ã®ã§ãƒªã‚»ãƒƒãƒˆ

    const selectedTheme = THEME_OPTIONS.find(o => o.id === theme);
    if (!selectedTheme) return;

    const prompt = `ãƒ†ãƒ¼ãƒã€Œ${selectedTheme.label}: ${selectedTheme.prompt}ã€ã«æœ€é©ãªæ—¥æœ¬ã®æ—…è¡Œå…ˆã‚’5ã¤ææ¡ˆã—ã¦ãã ã•ã„ã€‚
    ã€é‡è¦ã€‘ä»¥ä¸‹ã®JSONã‚¹ã‚­ãƒ¼ãƒã«å¾“ã„ã€æ—…è¡Œå…ˆåï¼ˆæ—¥æœ¬èªï¼‰ã¨ç°¡å˜ãªç´¹ä»‹ï¼ˆä¸€æ–‡ï¼‰ã®ãƒªã‚¹ãƒˆã‚’JSONå½¢å¼ã§ã®ã¿å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;

    const jsonSchema = {
        type: "array",
        items: {
            type: "object",
            properties: {
                name: { type: "string" },
                description: { type: "string" }
            },
            required: ["name", "description"]
        }
    };

    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: {
            responseMimeType: "application/json",
            responseSchema: jsonSchema
        }
    };

    try {
        const response = await fetchWithRetry(GEMINI_API_BASE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (jsonText) {
             const candidates = JSON.parse(jsonText);
             // JSONãŒé…åˆ—ã¾ãŸã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹ã“ã¨ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãƒªã‚¹ãƒˆã¨ã—ã¦è¨­å®š
             setDestinationCandidates(Array.isArray(candidates) ? candidates : [candidates].filter(c => c.name));
        } else {
             // å¿œç­”ãªã—ã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
             setErrorMsg('AIã‹ã‚‰æœ‰åŠ¹ãªå¿œç­”ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ãƒ¼ãƒã‚’å¤‰ãˆã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
             setDestinationCandidates([]);
        }

        setStep(2); // å€™è£œè¡¨ç¤ºã‚¹ãƒ†ãƒƒãƒ—ã¸
    } catch (error) {
        console.error("å€™è£œç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
        
        // â˜…ä¿®æ­£3: 401ã‚¨ãƒ©ãƒ¼ã®å ´åˆã«ç‰¹åˆ¥ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if (error.message.includes('401')) {
             setErrorMsg(`AIæ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆèªè¨¼å¤±æ•—ï¼‰ã€‚ã‚­ãƒ£ãƒ³ãƒã‚¹ç’°å¢ƒã®èªè¨¼ã‚­ãƒ¼è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        } else {
             setErrorMsg(`AIæ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚èªè¨¼ã‚­ãƒ¼ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚(${error.message})`);
        }
        
        // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š (å‹•ä½œç¢ºèªç”¨)
        setDestinationCandidates([
            { name: 'æ²–ç¸„ (ãƒ€ãƒŸãƒ¼)', description: 'AIæ¥ç¶šã‚¨ãƒ©ãƒ¼æ™‚ã®ä»£æ›¿å€™è£œã§ã™ã€‚' },
            { name: 'äº¬éƒ½ (ãƒ€ãƒŸãƒ¼)', description: 'AIæ¥ç¶šã‚¨ãƒ©ãƒ¼æ™‚ã®ä»£æ›¿å€™è£œã§ã™ã€‚' }
        ]);
        setStep(2); 
    } finally {
        setLoading(false);
    }
  };


  // Step 3: æœ€çµ‚çš„ãªãƒ—ãƒ©ãƒ³ã‚’AIã«ç”Ÿæˆã•ã›ã‚‹
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (loading) return;
    setLoading(true);
    setErrorMsg('');

    const authenticatedUid = auth?.currentUser?.uid;
    if (!authenticatedUid) {
        console.log(`ãƒ—ãƒ©ãƒ³ã®ä¿å­˜ã«ã¯èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ã‚¢ãƒ—ãƒªã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚`);
        setLoading(false);
        setErrorMsg('èªè¨¼ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã§ãã¾ã›ã‚“ã€‚');
        return;
    }
    
    const selectedTheme = THEME_OPTIONS.find(o => o.id === theme);

    const prompt = `ã‚ãªãŸã¯ãƒ—ãƒ­ã®æ—…è¡Œãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ã«åŸºã¥ãã€å®Ÿè¡Œå¯èƒ½ãª3æ—¥é–“ã®æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’JSONå½¢å¼ã§ã®ã¿å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
    - ç›®çš„åœ°: ${destination}
    - æ—…ã®ãƒ†ãƒ¼ãƒ: ${selectedTheme ? selectedTheme.label : 'æœªè¨­å®š'}
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰: ${themeText}
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‚¾å‘: ã‚¹ã‚¿ã‚¤ãƒ«ã¯ãƒªãƒ©ãƒƒã‚¯ã‚¹ã€äºˆç®—ã¯ä¸­ã€œé«˜ã€é£Ÿäº‹ã¯æµ·é®®ã‚’å¥½ã‚€ã€‚
    - æ—¥ç¨‹: Day 1 ã‹ã‚‰ Day 3 ã¾ã§ã€‚

    ã€é‡è¦ã€‘ä»¥ä¸‹ã®JSONã‚¹ã‚­ãƒ¼ãƒã«å¾“ã„ã€å›ç­”ã—ã¦ãã ã•ã„ã€‚
    `;

    // JSONã‚¹ã‚­ãƒ¼ãƒå®šç¾© (AIãŒå‡ºåŠ›ã™ã¹ãæ§‹é€ ã‚’å¼·åˆ¶ã™ã‚‹) - å¤‰æ›´ãªã—
    const jsonSchema = {
        type: "object",
        properties: {
            plan_id: { type: "string" },
            destination: { type: "string" },
            days: {
                type: "array",
                items: {
                    type: "object",
                    properties: {
                        day_number: { type: "integer" },
                        date: { type: "string", description: "ä¾‹: 10æœˆ1æ—¥" },
                        activities: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    time: { type: "string", description: "ä¾‹: 9:00" },
                                    spot_name: { type: "string" },
                                    duration: { type: "integer", description: "æ»åœ¨æ™‚é–“ï¼ˆåˆ†ï¼‰" },
                                    notes: { type: "string", description: "ç§»å‹•æ‰‹æ®µã‚„äºˆç´„æƒ…å ±ãªã©ã®ãƒ¡ãƒ¢" }
                                }
                            }
                        }
                    }
                }
            }
        },
        required: ["plan_id", "destination", "days"]
    };

    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: {
            responseMimeType: "application/json",
            responseSchema: jsonSchema
        }
    };

    try {
        const response = await fetchWithRetry(GEMINI_API_BASE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        
        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!jsonText) {
             setErrorMsg("AIã‹ã‚‰æœ‰åŠ¹ãªJSONå¿œç­”ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
             return;
        }
        
        const parsedPlan = JSON.parse(jsonText);
        
        // Firestoreã«ä¿å­˜
        const newPlanId = doc(collection(getFirestore(initializeApp(firebaseConfig)), `artifacts/${appId}/users/${authenticatedUid}/travel_plans`)).id;

        const planToSave = {
            id: newPlanId,
            ownerId: authenticatedUid,
            isPublic: false, 
            createdAt: serverTimestamp(),
            itinerary_json: parsedPlan,
            plan_name: `${parsedPlan.destination}ã®æ—…`
        };
        
        const db = getFirestore(initializeApp(firebaseConfig));
        const docRef = doc(db, `artifacts/${appId}/users/${authenticatedUid}/travel_plans`, newPlanId);
        await setDoc(docRef, planToSave);
        
        setPlanData(planToSave); 
        setStep(4); // å®Œäº†ã‚¹ãƒ†ãƒƒãƒ—ã¸
        console.log("ãƒ—ãƒ©ãƒ³ãŒç”Ÿæˆã•ã‚Œã€ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");

    } catch (error) {
        console.error("ãƒ—ãƒ©ãƒ³ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
        
        // â˜…ä¿®æ­£4: 401ã‚¨ãƒ©ãƒ¼ã®å ´åˆã«ç‰¹åˆ¥ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if (error.message.includes('401')) {
            setErrorMsg(`ãƒ—ãƒ©ãƒ³ç”Ÿæˆã‚¨ãƒ©ãƒ¼ï¼ˆèªè¨¼å¤±æ•—ï¼‰ã€‚ã‚­ãƒ£ãƒ³ãƒã‚¹ç’°å¢ƒã®èªè¨¼ã‚­ãƒ¼è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        } else {
            setErrorMsg(`ãƒ—ãƒ©ãƒ³ç”Ÿæˆã‚¨ãƒ©ãƒ¼: AIæ¥ç¶šã¾ãŸã¯JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°: ${error.message}`);
        }
    } finally {
        setLoading(false);
    }
  };


  // --- Step 1 UI: ãƒ†ãƒ¼ãƒé¸æŠ ---
  const renderStep1 = () => (
    <div className="space-y-4">
        <h3 className="text-lg font-bold text-indigo-700">ã‚¹ãƒ†ãƒƒãƒ— 1/3: æ—…ã®ãƒ†ãƒ¼ãƒã‚’é¸ã¶</h3>
        <p className="text-sm text-gray-600">ã¾ãšã¯ã€Œã©ã‚“ãªæ—…ã«ã—ãŸã„ã‹ã€ã‚’ç›´æ„Ÿã§é¸ã‚“ã§ãã ã•ã„ã€‚</p>
        <div className="grid grid-cols-2 gap-3">
            {THEME_OPTIONS.map(opt => (
                <button
                    key={opt.id}
                    onClick={() => setTheme(opt.id)}
                    className={`p-4 rounded-xl text-center shadow-md transition duration-200 
                        ${theme === opt.id 
                            ? 'bg-indigo-500 text-white ring-4 ring-indigo-300' 
                            : 'bg-gray-100 hover:bg-indigo-50 border border-gray-300'}`
                    }
                >
                    <span className="font-semibold">{opt.label}</span>
                </button>
            ))}
        </div>
        <button
            onClick={fetchDestinationCandidates}
            disabled={!theme || loading}
            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition disabled:opacity-50 flex items-center justify-center space-x-2"
        >
            {loading ? 
                <span className="animate-spin">ğŸŒ€</span> : 
                <span>æ¬¡ã¸: æ—…å…ˆå€™è£œã‚’è¦‹ã‚‹</span>
            }
        </button>
    </div>
  );

  // --- Step 2 UI: æ—…å…ˆé¸æŠ ---
  const renderStep2 = () => (
    <div className="space-y-4">
        <h3 className="text-lg font-bold text-indigo-700">ã‚¹ãƒ†ãƒƒãƒ— 2/3: ãŠã™ã™ã‚ã®æ—…å…ˆã‚’é¸ã¶</h3>
        <p className="text-sm text-gray-600">é¸æŠã—ãŸãƒ†ãƒ¼ãƒã«æœ€é©ãªæ—…å…ˆå€™è£œã§ã™ã€‚ä¸€ã¤é¸ã‚“ã§ãã ã•ã„ã€‚</p>
        
        {/* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º */}
        {errorMsg && (
            <div className="bg-red-100 p-3 rounded-lg text-red-700 text-sm border border-red-300">
                âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {errorMsg}
            </div>
        )}

        <div className="space-y-3 max-h-60 overflow-y-auto custom-scrollbar p-1">
            {destinationCandidates.length > 0 ? (
                destinationCandidates.map((candidate, index) => (
                    <button
                        key={index}
                        onClick={() => setDestination(candidate.name)}
                        className={`w-full text-left p-4 rounded-xl border transition duration-200 
                            ${destination === candidate.name 
                                ? 'bg-green-500 text-white ring-4 ring-green-300' 
                                : 'bg-white hover:bg-green-50 border-gray-300'}`
                        }
                    >
                        <span className="font-bold">{candidate.name}</span>
                        <p className="text-xs mt-1 italic opacity-80">{candidate.description}</p>
                    </button>
                ))
            ) : (
                <p className="text-gray-500 text-center py-4">å€™è£œãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ãƒ¼ãƒã‚’å†é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
            )}
        </div>
        <button
            onClick={() => setStep(3)}
            disabled={!destination || destinationCandidates.length === 0}
            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition disabled:opacity-50"
        >
            æœ€çµ‚èª¿æ•´ã¸é€²ã‚€
        </button>
        <button
            onClick={() => { setStep(1); setErrorMsg(''); setDestination(''); }}
            className="w-full text-sm text-gray-500 hover:text-indigo-500 pt-1"
        >
            ãƒ†ãƒ¼ãƒã‚’å†é¸æŠã™ã‚‹
        </button>
    </div>
  );

  // --- Step 3 UI: æœ€çµ‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…¥åŠ›ã¨ç”Ÿæˆ ---
  const renderStep3 = () => (
    <form onSubmit={handleSubmit} className="space-y-4">
        <h3 className="text-lg font-bold text-indigo-700">ã‚¹ãƒ†ãƒƒãƒ— 3/3: æœ€çµ‚èª¿æ•´ã¨ç”Ÿæˆ</h3>
        
        {/* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º */}
        {errorMsg && (
            <div className="bg-red-100 p-3 rounded-lg text-red-700 text-sm border border-red-300">
                âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {errorMsg}
            </div>
        )}
        
        <div className="bg-green-100 p-3 rounded-lg border border-green-300">
            <p className="text-sm font-semibold text-green-700">æ±ºå®šå†…å®¹</p>
            <p className="text-xs">ãƒ†ãƒ¼ãƒ: {THEME_OPTIONS.find(o => o.id === theme)?.label}</p>
            <p className="text-xs">æ—…å…ˆ: {destination}</p>
        </div>

        <div>
            <label className="block text-sm font-medium text-gray-700">è‡ªç”±å…¥åŠ›ï¼ˆæ›–æ˜§ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰</label>
            <textarea
                value={themeText}
                onChange={(e) => setThemeText(e.target.value)}
                placeholder="ä¾‹: ãƒ“ãƒ¼ãƒã§ç™’ã‚„ã•ã‚ŒãŸã„ã€ãŠã—ã‚ƒã‚Œãªã‚«ãƒ•ã‚§å·¡ã‚Šã¨åœ°å…ƒã‚°ãƒ«ãƒ¡ã‚’æ¥½ã—ã¿ãŸã„"
                rows="3"
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                required
            />
            <p className="text-xs text-gray-500 mt-1">ã€Œãƒ†ãƒ¼ãƒã€ã¨ã€Œæ—…å…ˆã€ã«åŸºã¥ãã€AIãŒæ—…ç¨‹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
        </div>
        
        <button
          type="submit"
          className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg transition duration-200 disabled:opacity-50 flex items-center justify-center"
          disabled={loading}
        >
          {loading ? (
            <>
              <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              AIãŒå®Œç’§ãªãƒ—ãƒ©ãƒ³ã‚’è¨­è¨ˆä¸­...
            </>
          ) : (
            'ğŸš€ å®Œç’§ãªæ—…ç¨‹ã‚’AIã«ç”Ÿæˆã—ã¦ã‚‚ã‚‰ã†'
          )}
        </button>
        <button
            onClick={() => setStep(2)}
            className="w-full text-sm text-gray-500 hover:text-indigo-500 pt-1"
            type="button"
        >
            æ—…å…ˆã‚’å†é¸æŠã™ã‚‹
        </button>
    </form>
  );
  
  // --- Step 4 UI: å®Œäº†ã¨æ¬¡ã¸ ---
  const renderStep4 = () => (
    <div className="space-y-6 p-6 text-center bg-green-50 rounded-xl border border-green-300">
        <h3 className="text-2xl font-bold text-green-700">âœ… ãƒ—ãƒ©ãƒ³ç”Ÿæˆå®Œäº†ï¼</h3>
        <p className="text-gray-700">å³å´ã®ç·¨é›†ã‚¨ãƒªã‚¢ã«æ–°ã—ã„æ—…ç¨‹ãŒåæ˜ ã•ã‚Œã¾ã—ãŸã€‚</p>
        <p className="text-sm text-gray-600">ã•ã‚ã€ãƒ—ãƒ©ãƒ³ã‚’ç¢ºèªãƒ»ç·¨é›†ã—ã¦ã€æ—…ãƒŠã‚«AIãƒãƒ£ãƒƒãƒˆã§ç›¸è«‡ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
        <button
            onClick={() => { setStep(1); setDestination(''); setTheme(''); setThemeText(''); setErrorMsg(''); }}
            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition"
        >
            æ–°ã—ã„ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã™ã‚‹
        </button>
    </div>
  );


  // --- ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
  return (
    <div className="bg-white p-6 rounded-xl shadow-xl">
        <div className="text-lg font-bold text-gray-800 mb-4">
            <span className="text-indigo-600">ã‚¹ãƒ†ãƒƒãƒ— {step}</span> / æ—…ã®ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°
        </div>
        {step === 1 && renderStep1()}
        {step === 2 && renderStep2()}
        {step === 3 && renderStep3()}
        {step === 4 && renderStep4()}
    </div>
  );
};


/**
 * ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 */
const App = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [currentPlan, setCurrentPlan] = useState(null);
  const [plans, setPlans] = useState([]);

  // 1. FirebaseåˆæœŸåŒ–ã¨èªè¨¼
  useEffect(() => {
    const app = initializeApp(firebaseConfig);
    const firestore = getFirestore(app);
    const authInstance = getAuth(app);
    setDb(firestore);
    setAuth(authInstance);

    // èªè¨¼å‡¦ç†
    const handleAuth = async () => {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(authInstance, initialAuthToken);
            } else {
                await signInAnonymously(authInstance);
            }
        } catch (error) {
            console.error("Firebase Auth Error:", error);
        }
    };
    handleAuth();

    // èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
    const unsubscribe = onAuthStateChanged(authInstance, (user) => {
        if (user) {
            setUserId(user.uid); // èªè¨¼æ¸ˆã¿UID
        } else {
            // èªè¨¼ãŒç¢ºèªã§ããªã„å ´åˆã§ã‚‚ã€UIè¡¨ç¤ºç”¨ã«ãƒ©ãƒ³ãƒ€ãƒ ãªIDã‚’ä½¿ç”¨
            setUserId(crypto.randomUUID());
        }
        setIsAuthReady(true);
    });

    return () => unsubscribe();
  }, []);
  
  // 2. ãƒ—ãƒ©ãƒ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ (onSnapshot)
  useEffect(() => {
    if (!db || !auth || !isAuthReady) return; 

    // èªè¨¼æ¸ˆã¿UIDãŒå–å¾—ã§ãã‚‹ã¾ã§ãƒªã‚¹ãƒŠãƒ¼ã‚’å®Ÿè¡Œã—ãªã„
    const authenticatedUid = auth.currentUser?.uid;
    if (!authenticatedUid) {
        console.log("Firestore: User not fully authenticated yet, skipping listener.");
        setPlans([]);
        setCurrentPlan(null);
        return; 
    }

    // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ‘ã‚¹ã«å¤‰æ›´
    const plansCollectionRef = collection(db, `artifacts/${appId}/users/${authenticatedUid}/travel_plans`);
    const q = query(plansCollectionRef); 

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedPlans = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setPlans(fetchedPlans);
      // NOTE: ãƒ—ãƒ©ãƒ³ç”Ÿæˆæ™‚ã«setCurrentPlanãŒç›´æ¥å‘¼ã°ã‚Œã‚‹ãŸã‚ã€ã“ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§ãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸã‚Šã€éå»ã®ãƒ—ãƒ©ãƒ³ã‚’å¾©å…ƒã™ã‚‹å ´åˆã«ã®ã¿é‡è¦ã«ãªã‚‹
      if (fetchedPlans.length > 0 && !currentPlan) {
        // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«æœ€æ–°ã®ãƒ—ãƒ©ãƒ³ã‚’ã‚»ãƒƒãƒˆ
        // å®Ÿéš›ã«ã¯ createdAt ã‚„ updatedAt ã§ã‚½ãƒ¼ãƒˆã™ã¹ãã ãŒã€ã“ã“ã§ã¯æœ€å¾Œã®è¦ç´ ã‚’æœ€æ–°ã¨ã™ã‚‹
        setCurrentPlan(fetchedPlans[fetchedPlans.length - 1]);
      }
    }, (error) => {
      console.error("Firestore error:", error);
    });

    return () => unsubscribe();
  }, [db, auth, isAuthReady, appId, currentPlan]);
  
  // 3. ãƒ—ãƒ©ãƒ³ã®æ›´æ–°ãƒãƒ³ãƒ‰ãƒ©
  const handleUpdatePlan = useCallback(async (updatedPlan) => {
    if (!db || !updatedPlan || !updatedPlan.id || !auth) {
        console.log("Cannot update plan: DB or Auth not ready.");
        return;
    }
    
    // èªè¨¼æ¸ˆã¿UIDãŒå–å¾—ã§ãã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const authenticatedUid = auth.currentUser?.uid;
    if (!authenticatedUid) {
        console.log("Cannot update plan: User not authenticated.");
        return;
    }
    
    try {
        // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ãƒ‘ã‚¹ã«èªè¨¼æ¸ˆã¿UIDã‚’ä½¿ç”¨
        const planDocRef = doc(db, `artifacts/${appId}/users/${authenticatedUid}/travel_plans`, updatedPlan.id);
        
        await setDoc(planDocRef, {
            ...updatedPlan,
            updatedAt: serverTimestamp() // æ›´æ–°æ—¥æ™‚ã‚’è¨˜éŒ²
        }, { merge: true }); // ãƒãƒ¼ã‚¸ã—ã¦æ›´æ–°
        
        // æ›´æ–°å¾Œã€å³åº§ã«UIã«åæ˜ 
        setCurrentPlan(updatedPlan);
        
    } catch (error) {
        console.error("ãƒ—ãƒ©ãƒ³æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        console.log('ãƒ—ãƒ©ãƒ³ã®åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
  }, [db, auth, appId]); 
  
  const currentPlanId = currentPlan ? currentPlan.id : 'N/A';
  
  if (!isAuthReady) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <p className="text-xl text-indigo-600">ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–ä¸­...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 p-6 font-sans">
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 4px; }
      `}</style>
      
      <header className="text-center mb-10">
        <h1 className="text-4xl font-extrabold text-indigo-700">æ—…ã®è¨­è¨ˆå£« AIãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>
        <p className="text-gray-600 mt-2">ãƒ†ãƒ¼ãƒé¸æŠã‹ã‚‰å§‹ã‚ã‚‹ã€å®Œç’§ãªæ—…ãƒŠã‚«ã‚µãƒãƒ¼ãƒˆã€‚</p>
        <p className="text-xs text-gray-400 mt-1">ã‚ãªãŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (åŒè¡Œè€…ã¨å…±æœ‰): <span className="font-mono text-indigo-500">{userId}</span></p>
        {currentPlan && <p className="text-xs text-gray-400 mt-1">ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ID: <span className="font-mono text-indigo-500">{currentPlanId}</span></p>}
      </header>
      
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼: ãƒ—ãƒ©ãƒ³ç”Ÿæˆã¨ãƒãƒ£ãƒƒãƒˆ */}
        <div className="lg:col-span-1 space-y-8">
          <PlanGeneratorForm setPlanData={setCurrentPlan} auth={auth} /> {/* authã‚’æ¸¡ã™ */}
          
          <div className="h-[400px]">
            <AIChat currentPlan={currentPlan} userId={userId} />
          </div>
        </div>
        
        {/* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢: ãƒ—ãƒ©ãƒ³è¡¨ç¤ºã¨ç·¨é›† */}
        <div className="lg:col-span-2">
          <PlanDisplay 
            plan={currentPlan} 
            isEditable={true} 
            onUpdatePlan={handleUpdatePlan} 
            isMyPlan={true} 
          />
        </div>
      </div>
      
    </div>
  );
};

export default App;
